---
alwaysApply: true
---
# Lien Project - Cursor Rules

## Project Overview
You are working on **Lien** - a local-first semantic code search tool that provides context to AI coding assistants via MCP (Model Context Protocol).

**Key Facts:**
- Brand: Lien (French for "link/connection")
- Domain: lien.dev
- Default Port: 7133 (L=7, I=1, E=3, N=3)
- License: MIT License
- Target: TypeScript/Node.js CLI tool (monorepo structure)
- Package: @liendev/lien
- Current Version: 0.5.0

## Core Principles

### KISS (Keep It Simple, Stupid)
- Prefer simple solutions over clever ones
- Write code that junior developers can understand
- Avoid unnecessary abstractions
- Default to straightforward implementations
- Question complexity - "Can this be simpler?"

### YAGNI (You Aren't Gonna Need It)
- Don't build features "just in case"
- Implement only what's needed for current requirements
- Resist gold-plating and over-engineering
- Wait for actual need before adding functionality
- Delete unused code aggressively

### DRY (Don't Repeat Yourself)
- Extract repeated logic into shared functions
- But: Don't abstract too early (wait for 3rd use)
- Duplication is better than wrong abstraction
- Keep related code co-located when it makes sense

### Single Responsibility Principle
- Each function/class should do ONE thing well
- If you can't explain what a function does in one sentence, split it
- Files should have a clear, singular purpose

### Fail Fast
- Validate inputs early
- Throw errors immediately when something is wrong
- Don't let bad data propagate through the system
- Use TypeScript types to catch errors at compile time

## Code Style & Standards

### TypeScript
```typescript
// âœ… Good: Clear, typed, simple
async function indexFile(filepath: string): Promise<CodeChunk[]> {
  const content = await fs.readFile(filepath, 'utf-8');
  return chunkFile(filepath, content);
}

// âŒ Bad: Overly clever, hard to understand
const indexFile = (fp: string) => 
  fs.readFile(fp, 'utf-8').then(c => chunkFile(fp, c));
```

### Naming Conventions
- **Variables/Functions:** camelCase (`indexFile`, `vectorDB`)
- **Classes/Interfaces:** PascalCase (`VectorDB`, `CodeChunk`)
- **Constants:** UPPER_SNAKE_CASE (`DEFAULT_PORT`, `MAX_CHUNK_SIZE`)
- **Files:** kebab-case (`vector-db.ts`, `code-chunker.ts`)
- **Be descriptive:** `getUserById` not `get`, `calculateEmbedding` not `calc`

### File Organization
```
lien/
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ cli/                    # Main CLI package
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ cli/            # CLI commands (init, index, serve, status)
â”‚       â”‚   â”œâ”€â”€ mcp/            # MCP server implementation
â”‚       â”‚   â”œâ”€â”€ indexer/        # Code indexing, chunking, test associations
â”‚       â”‚   â”œâ”€â”€ embeddings/     # Local embedding generation
â”‚       â”‚   â”œâ”€â”€ vectordb/       # LanceDB vector storage
â”‚       â”‚   â”œâ”€â”€ config/         # Configuration management & migration
â”‚       â”‚   â”œâ”€â”€ frameworks/     # Framework detection (Node.js, Laravel)
â”‚       â”‚   â”œâ”€â”€ git/            # Git integration and tracking
â”‚       â”‚   â”œâ”€â”€ watcher/        # File watching (planned)
â”‚       â”‚   â”œâ”€â”€ types/          # Shared TypeScript types
â”‚       â”‚   â””â”€â”€ utils/          # Utilities and helpers
â”‚       â”œâ”€â”€ test/
â”‚       â”‚   â”œâ”€â”€ integration/    # Integration tests
â”‚       â”‚   â”œâ”€â”€ helpers/        # Test utilities
â”‚       â”‚   â””â”€â”€ fixtures/       # Test data
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ scripts/                    # Release and automation scripts
â””â”€â”€ package.json                # Root monorepo config
```

### Imports
```typescript
// âœ… Good: Organized, clear sections
// Node built-ins first
import fs from 'fs/promises';
import path from 'path';

// External dependencies
import { Command } from 'commander';
import ora from 'ora';

// Internal modules
import { VectorDB } from '../vectordb/lancedb.js';
import { LocalEmbeddings } from '../embeddings/local.js';
import type { CodeChunk, IndexOptions } from '../types/index.js';

// âŒ Bad: Random order, unclear
import { VectorDB } from '../vectordb/lancedb.js';
import path from 'path';
import type { CodeChunk } from '../types/index.js';
import ora from 'ora';
```

## Development Workflow

### Before Every Commit - Health Checks (MANDATORY)

**1. Type Check**
```bash
npm run typecheck
# Must pass with 0 errors
```

**2. Build**
```bash
npm run build
# Must compile successfully
```

**3. Test**
```bash
npm test
# All tests must pass
```

### Git Commit Messages
Follow Conventional Commits:
```bash
# Format: <type>(<scope>): <subject>

# Types:
feat: New feature
fix: Bug fix
docs: Documentation only
style: Code style (formatting, missing semicolons, etc)
refactor: Code change that neither fixes bug nor adds feature
perf: Performance improvement
test: Adding tests
chore: Maintenance (deps, build, etc)

# Examples:
feat(mcp): add semantic_search tool
fix(indexer): handle binary files gracefully
docs(readme): add installation instructions
refactor(vectordb): simplify query interface
perf(embeddings): batch embed operations
chore(deps): update transformers.js to 2.17.1
```

### Branch Naming
```bash
# Format: <type>/<short-description>

feature/mcp-server
fix/binary-file-crash
docs/api-documentation
refactor/vector-db-interface
```

## Error Handling

### Always Handle Errors Explicitly
```typescript
// âœ… Good: Clear error handling
async function indexCodebase(rootDir: string): Promise<void> {
  try {
    const files = await scanCodebase({ rootDir });
    
    for (const file of files) {
      try {
        const content = await fs.readFile(file, 'utf-8');
        await processFile(file, content);
      } catch (error) {
        // Log but continue with other files
        console.warn(`Skipping ${file}: ${error.message}`);
      }
    }
  } catch (error) {
    // Fatal error - re-throw with context
    throw new Error(`Failed to index codebase: ${error.message}`);
  }
}

// âŒ Bad: Silent failures
async function indexCodebase(rootDir: string) {
  const files = await scanCodebase({ rootDir });
  for (const file of files) {
    await processFile(file); // What if this fails?
  }
}
```

### User-Facing Error Messages
```typescript
// âœ… Good: Helpful, actionable
throw new Error(
  'Failed to initialize vector database. ' +
  'Please ensure you have write permissions to ~/.lien/'
);

// âŒ Bad: Cryptic, unhelpful
throw new Error('DB init failed');
```

## Performance Guidelines

### Profile Before Optimizing
```typescript
// Don't optimize without measuring first
// Use console.time for quick profiling:

console.time('indexing');
await indexCodebase(rootDir);
console.timeEnd('indexing');
// indexing: 2341.234ms
```

### Batch Operations
```typescript
// âœ… Good: Batch for efficiency
async function embedBatch(texts: string[]): Promise<Float32Array[]> {
  // Process 10 at a time
  const batchSize = 10;
  const results: Float32Array[] = [];
  
  for (let i = 0; i < texts.length; i += batchSize) {
    const batch = texts.slice(i, i + batchSize);
    const embeddings = await Promise.all(
      batch.map(text => this.embed(text))
    );
    results.push(...embeddings);
  }
  
  return results;
}

// âŒ Bad: One at a time (slow)
async function embedBatch(texts: string[]): Promise<Float32Array[]> {
  const results: Float32Array[] = [];
  for (const text of texts) {
    results.push(await this.embed(text)); // Sequential, slow
  }
  return results;
}
```

### Memory Consciousness
```typescript
// âœ… Good: Stream large files
import { createReadStream } from 'fs';

async function processLargeFile(filepath: string) {
  const stream = createReadStream(filepath, { encoding: 'utf-8' });
  // Process in chunks
}

// âŒ Bad: Load entire file into memory
const content = await fs.readFile(filepath, 'utf-8'); // Could be GBs
```

## Testing Philosophy

### Test the Public API
```typescript
// âœ… Good: Test behavior, not implementation
describe('VectorDB', () => {
  it('should return similar results for similar queries', async () => {
    const db = new VectorDB('/tmp/test');
    await db.initialize();
    
    const vector1 = [0.1, 0.2, 0.3];
    await db.insert([vector1], [{ content: 'test' }]);
    
    const results = await db.search([0.11, 0.21, 0.31], 1);
    expect(results).toHaveLength(1);
    expect(results[0].score).toBeGreaterThan(0.9);
  });
});

// âŒ Bad: Testing internal implementation
it('should call _formatVector internally', () => {
  // Don't test private methods
});
```

### Keep Tests Simple
```typescript
// âœ… Good: Clear, single assertion
it('should chunk file into 75-line blocks', () => {
  const content = 'line1\n'.repeat(150);
  const chunks = chunkFile('test.ts', content);
  
  expect(chunks).toHaveLength(2);
});

// âŒ Bad: Multiple unrelated assertions
it('should do everything', () => {
  // Tests too many things at once
  expect(chunks.length).toBe(2);
  expect(chunks[0].metadata.language).toBe('typescript');
  expect(db.insert).toHaveBeenCalled();
  // ... 10 more assertions
});
```

## Documentation

### README First
- Update README.md when adding new features
- Include examples of common use cases
- Keep installation instructions up-to-date

### Code Comments
```typescript
// âœ… Good: Explain WHY, not WHAT
// Use overlap to ensure context isn't lost at chunk boundaries
const overlap = 10;

// âŒ Bad: State the obvious
// Set overlap to 10
const overlap = 10;

// âœ… Good: Document complex logic
/**
 * Chunks code file into overlapping segments for better semantic search.
 * 
 * Overlap ensures that code spanning chunk boundaries isn't lost.
 * For example, a function definition at line 74 will appear in both
 * the chunk ending at line 75 and the chunk starting at line 65.
 * 
 * @param filepath - Path to the source file
 * @param content - File contents as string
 * @returns Array of code chunks with metadata
 */
function chunkFile(filepath: string, content: string): CodeChunk[] {
  // Implementation
}
```

### JSDoc for Public APIs
```typescript
// âœ… Good: Document all public functions
/**
 * Initializes the vector database at the specified path.
 * 
 * Creates necessary directories and tables if they don't exist.
 * Safe to call multiple times (idempotent).
 * 
 * @throws {Error} If path is not writable
 */
async initialize(): Promise<void> {
  // Implementation
}
```

## Dependencies

### Minimize Dependencies
```typescript
// âœ… Good: Use Node.js built-ins when possible
import { readFile } from 'fs/promises';

// âŒ Bad: Add dependency for simple task
import fs from 'fs-extra'; // Do we really need this?
```

### Audit Before Adding
Before `npm install <package>`:
1. Check weekly downloads (>100k preferred)
2. Check last update date (<6 months preferred)
3. Check open issues count
4. Check license (must be compatible)
5. Check bundle size (https://bundlephobia.com)

### Lock Dependencies
```json
// âœ… Good: Exact versions for stability
{
  "dependencies": {
    "commander": "12.0.0",
    "chalk": "5.3.0"
  }
}

// âŒ Bad: Ranges can break builds
{
  "dependencies": {
    "commander": "^12.0.0", // Could install 12.9.9 later
  }
}
```

## Security

### Never Commit Secrets
```bash
# Add to .gitignore
.env
.env.local
*.pem
*.key
config/secrets.json
```

### Validate User Input
```typescript
// âœ… Good: Validate and sanitize
function setPort(port: string): number {
  const parsed = parseInt(port, 10);
  
  if (isNaN(parsed) || parsed < 1024 || parsed > 65535) {
    throw new Error('Port must be between 1024 and 65535');
  }
  
  return parsed;
}

// âŒ Bad: Trust user input
function setPort(port: string): number {
  return parseInt(port); // Could be NaN, negative, etc.
}
```

## Current Status (v0.5.0)

### âœ… Implemented Features
- CLI commands (init, index, serve, status, reindex)
- File scanning with .gitignore support
- Line-based chunking with overlap
- Local embeddings (transformers.js with all-MiniLM-L6-v2)
- LanceDB integration for vector storage
- MCP server with 4 tools (semantic_search, find_similar, get_file_context, list_functions)
- Progress indicators and user-friendly CLI
- Test association with two-pass detection (convention + import analysis)
- Framework detection and monorepo support (Node.js, Laravel)
- Configuration file with migration support
- Cursor rules installation during init
- Comprehensive test coverage

### ğŸš§ Roadmap (v0.6+)
- âŒ Tree-sitter parsing for better code understanding
- âŒ Incremental indexing / watch mode for real-time updates
- âŒ Multi-repo support
- âŒ Web dashboard for visualization
- âŒ Team features and collaboration
- âŒ GitHub PR review integration
- âŒ Multiple embedding model options
- âŒ Cloud sync (optional)

### Decision Framework
When tempted to add a feature, ask:
1. Is this needed for MVP? (No â†’ defer)
2. Can users work around this? (Yes â†’ defer)
3. Can we add this later without breaking changes? (Yes â†’ defer)
4. Is this critical for the core value prop? (No â†’ defer)

## Common Patterns

### Loading Spinners
```typescript
import ora from 'ora';

const spinner = ora('Indexing codebase...').start();

try {
  await indexCodebase(rootDir);
  spinner.succeed('Indexed successfully');
} catch (error) {
  spinner.fail(`Indexing failed: ${error.message}`);
  throw error;
}
```

### Configuration Loading
```typescript
// Load with sensible defaults
const config = {
  ...defaultConfig,
  ...loadUserConfig(),
};
```

### Graceful Degradation
```typescript
// Try best, fall back gracefully
try {
  const gitignore = await fs.readFile('.gitignore', 'utf-8');
  ig.add(gitignore);
} catch {
  // No .gitignore, that's fine - use defaults
  console.log('No .gitignore found, using default exclusions');
}
```

## When in Doubt

1. **Prefer readability over cleverness**
2. **Make it work, then make it good, then (maybe) make it fast**
3. **Delete code rather than comment it out**
4. **Ask: "Will I understand this in 6 months?"**
5. **Test on real codebases early and often**

## Release Process

Lien uses an automated release script (`scripts/release.sh`) that handles:
- âœ… Version bumping (semantic versioning)
- âœ… Building the project
- âœ… Updating CHANGELOG.md
- âœ… Creating git commit and tag
- âœ… Rollback on build failure

### Usage

```bash
npm run release -- <bump_type> "<commit_message>"
```

**Bump types:**
- `patch` - Bug fixes (0.5.0 â†’ 0.5.1)
- `minor` - New features (0.5.0 â†’ 0.6.0)
- `major` - Breaking changes (0.5.0 â†’ 1.0.0)

**Examples:**

```bash
# Bug fix
npm run release -- patch "fix: improve reconnection logic"

# New feature
npm run release -- minor "feat: add Python test detection"

# Breaking change
npm run release -- major "BREAKING: new API structure"
```

### What the Script Does

1. **Validates** uncommitted changes (warns if any)
2. **Bumps** version in `packages/cli/package.json`
3. **Builds** the project (`npm run build`)
4. **Updates** CHANGELOG.md with categorized entry
5. **Commits** changes with version tag
6. **Creates** git tag (e.g., `v0.5.1`)
7. **Shows** next steps for pushing

### After Release

```bash
# Push commit and tag to GitHub
git push origin main
git push origin v0.5.1  # Replace with your version
```

### Commit Message Format

Follow Conventional Commits for automatic changelog categorization:

```
<type>(<scope>): <description>

Types:
- feat:     New feature     â†’ CHANGELOG: "Added"
- fix:      Bug fix        â†’ CHANGELOG: "Fixed"
- perf:     Performance    â†’ CHANGELOG: "Fixed"
- docs:     Documentation  â†’ CHANGELOG: "Documentation"
- refactor: Code refactor  â†’ CHANGELOG: "Changed"
- style:    Code style     â†’ CHANGELOG: "Changed"
- test:     Tests          â†’ CHANGELOG: "Changed"
- chore:    Maintenance    â†’ CHANGELOG: "Changed"
```

### Troubleshooting

**Build fails during release:**
The script automatically rolls back the version change. Fix the build issue and try again.

**Uncommitted changes warning:**
Commit or stash your changes first, or type `y` to continue anyway (not recommended).

## Pre-Commit Checklist

Before every `git commit`:
- [ ] Run `npm run typecheck` (0 errors)
- [ ] Run `npm run build` (successful)
- [ ] Run `npm test` (all tests pass)
- [ ] Test manually if changes affect CLI
- [ ] Update README if adding features
- [ ] Commit message follows convention

## Package.json Scripts Reference

**Root Level (monorepo):**
```json
{
  "scripts": {
    "build": "npm run build -w packages/cli",
    "dev": "npm run dev -w packages/cli",
    "typecheck": "npm run typecheck -w packages/cli",
    "clean": "rm -rf packages/*/dist",
    "release": "./scripts/release.sh"
  }
}
```

**CLI Package (packages/cli):**
```json
{
  "scripts": {
    "build": "tsup && chmod +x dist/index.js && sed -i '' '1s/^/#!\\/usr\\/bin\\/env node\\n/' dist/index.js",
    "dev": "tsup --watch",
    "prepublishOnly": "npm run build",
    "typecheck": "tsc --noEmit",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage"
  }
}
```

## Remember

**Ship early, ship often.**

Perfect is the enemy of done. Get the MVP working, get it into users' hands, iterate based on feedback.

The best code is code that solves real problems for real users.

---

*"Any fool can write code that a computer can understand. Good programmers write code that humans can understand."* - Martin Fowler
