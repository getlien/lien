# Lien Project Guidelines

## TypeScript & ESM
- Use ESM syntax exclusively (import/export)
- Always include .js extensions in imports (e.g., `import { foo } from './bar.js'`)
- Set `"type": "module"` in package.json
- Use modern ES2022+ features
- Strict type checking enabled - avoid `any`, use proper interfaces

## MCP SDK Patterns
- Use stdio transport for MCP server communication
- Implement proper error handling in all MCP tool handlers
- Wrap MCP handlers in try-catch blocks
- Log to stderr (stdout is reserved for MCP protocol)
- Return structured responses with proper typing
- Follow MCP protocol specifications strictly

## Async/Await
- Use async/await for all I/O operations
- Prefer Promise.all() for parallel operations
- Handle promise rejections properly
- No callback-style code

## Error Handling
- Graceful error handling throughout
- User-friendly error messages
- Log detailed errors to stderr when --verbose is used
- Never crash without helpful context
- Handle ENOENT, permission errors, and network issues

## Vector Database
- Always call initialize() before using VectorDB
- Close connections properly on shutdown
- Handle missing indices gracefully
- Batch operations where possible for performance

## Embeddings
- Lazy-load models (don't initialize until needed)
- Use batch operations for efficiency
- Cache models in ~/.lien/models
- Handle model download failures gracefully
- Show progress during model downloads

## File I/O
- Use fs/promises for all file operations
- Handle ENOENT gracefully (file not found)
- Respect .gitignore patterns
- Use streaming for large files when possible
- Close file handles properly

## CLI/UX
- Use ora for long-running operations with spinners
- Use chalk for colored output
- Show meaningful progress (file names, counts, time estimates)
- Support --verbose flag for debugging
- Support --help for all commands
- Graceful handling of Ctrl+C

## Code Organization
- One responsibility per file
- Export interfaces from types.ts files
- Keep functions small and focused
- Use descriptive names (no single-letter vars except loops)
- Add JSDoc comments for public APIs

## Performance
- Batch embedding generation (10-50 at a time)
- Use streaming for large codebases
- Avoid loading entire files into memory when possible
- Cache frequently accessed data
- Profile indexing performance

## Testing & Validation
- Test on own codebase (dogfood)
- Verify .gitignore patterns work
- Test with various project sizes
- Validate MCP integration with Cursor
- Check memory usage during indexing

## Git Workflow & Version Control
- **ALWAYS commit changes after each iteration or logical set of changes**
- Commit after completing each TODO item or feature
- Write clear, descriptive commit messages following conventional commits:
  - `feat: add PHP support to language detection`
  - `fix: resolve embedding initialization race condition`
  - `docs: update README with Cursor setup instructions`
  - `refactor: simplify chunking logic`
  - `test: add integration test for MCP server`
  - `chore: update dependencies`
- Keep commits focused and atomic (one logical change per commit)
- Build and test before committing to ensure working state
- Don't commit broken code or work-in-progress without clear WIP marker
- If multiple related changes, use multiple commits with clear progression
- Rebuild (`npm run build`) after source changes before committing dist/

