{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\n * Lien AI Code Review GitHub Action\n *\n * Thin adapter over @liendev/review. Reads GitHub Actions inputs,\n * creates the Octokit instance from @actions/github, and delegates\n * to the shared review engine.\n */\n\nimport * as core from '@actions/core';\nimport * as github from '@actions/github';\nimport {\n  type Logger,\n  type ReviewConfig,\n  type ReviewSetup,\n  type ReviewStyle,\n  orchestrateAnalysis,\n  handleAnalysisOutputs,\n  postReviewIfNeeded,\n} from '@liendev/review';\n\n/**\n * Wrap @actions/core as a Logger\n */\nconst actionsLogger: Logger = {\n  info: (msg: string) => core.info(msg),\n  warning: (msg: string) => core.warning(msg),\n  error: (msg: string) => core.error(msg),\n  debug: (msg: string) => core.debug(msg),\n};\n\n/**\n * Read action inputs into ReviewConfig\n */\nfunction getConfig(): ReviewConfig {\n  const reviewStyle = core.getInput('review_style') || 'line';\n\n  return {\n    openrouterApiKey: core.getInput('openrouter_api_key', { required: true }),\n    model: core.getInput('model') || 'anthropic/claude-sonnet-4',\n    threshold: core.getInput('threshold') || '15',\n    reviewStyle: (reviewStyle === 'summary' ? 'summary' : 'line') as ReviewStyle,\n    enableDeltaTracking: core.getInput('enable_delta_tracking') === 'true',\n    baselineComplexityPath: core.getInput('baseline_complexity') || '',\n  };\n}\n\n/**\n * Get PR context from the GitHub event\n */\nfunction getPRContext() {\n  const { context } = github;\n\n  if (!context.payload.pull_request) {\n    core.warning('This action only works on pull_request events');\n    return null;\n  }\n\n  const pr = context.payload.pull_request;\n\n  return {\n    owner: context.repo.owner,\n    repo: context.repo.repo,\n    pullNumber: pr.number,\n    title: pr.title as string,\n    baseSha: pr.base.sha as string,\n    headSha: pr.head.sha as string,\n  };\n}\n\n/**\n * Set GitHub Action outputs from analysis results\n */\nfunction setOutputs(\n  deltaSummary: { totalDelta: number; improved: number; degraded: number } | null,\n  report: { summary: { totalViolations: number; bySeverity: { error: number; warning: number } } }\n): void {\n  if (deltaSummary) {\n    core.setOutput('total_delta', deltaSummary.totalDelta);\n    core.setOutput('improved', deltaSummary.improved);\n    core.setOutput('degraded', deltaSummary.degraded);\n  }\n\n  core.setOutput('violations', report.summary.totalViolations);\n  core.setOutput('errors', report.summary.bySeverity.error);\n  core.setOutput('warnings', report.summary.bySeverity.warning);\n}\n\n/**\n * Main action logic\n */\nasync function run(): Promise<void> {\n  try {\n    core.info('Starting Lien AI Code Review...');\n    core.info(`Node version: ${process.version}`);\n    core.info(`Working directory: ${process.cwd()}`);\n\n    const config = getConfig();\n    core.info(`Using model: ${config.model}`);\n    core.info(`Complexity threshold: ${config.threshold}`);\n    core.info(`Review style: ${config.reviewStyle}`);\n\n    const githubToken = core.getInput('github_token') || process.env.GITHUB_TOKEN || '';\n    if (!githubToken) {\n      throw new Error('GitHub token is required');\n    }\n\n    const prContext = getPRContext();\n    if (!prContext) {\n      core.info('Not running in PR context, exiting gracefully');\n      return;\n    }\n\n    core.info(`Reviewing PR #${prContext.pullNumber}: ${prContext.title}`);\n\n    const octokit = github.getOctokit(githubToken);\n\n    const setup: ReviewSetup = {\n      config,\n      prContext,\n      // @actions/github's Octokit is compatible with @octokit/rest API surface\n      octokit: octokit.rest as unknown as import('@octokit/rest').Octokit,\n      logger: actionsLogger,\n      rootDir: process.cwd(),\n    };\n\n    const analysisResult = await orchestrateAnalysis(setup);\n    if (!analysisResult) {\n      return;\n    }\n\n    const deltaSummary = await handleAnalysisOutputs(analysisResult, setup);\n    setOutputs(deltaSummary, analysisResult.currentReport);\n    await postReviewIfNeeded(analysisResult, setup);\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'An unexpected error occurred';\n    const stack = error instanceof Error ? error.stack : '';\n    core.error(`Action failed: ${message}`);\n    if (stack) {\n      core.error(`Stack trace:\\n${stack}`);\n    }\n    core.setFailed(message);\n  }\n}\n\n// Run the action\nrun().catch((error) => {\n  core.setFailed(error instanceof Error ? error.message : String(error));\n  process.exit(1);\n});\n"],"mappings":"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","names":["error"]}